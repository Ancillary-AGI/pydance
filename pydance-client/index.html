<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pydance Client Framework</title>
  <meta name="description" content="Next-Generation, Signal-Based Frontend Framework">

  <!-- Preload critical resources -->
  <link rel="preload" href="/src/index.js" as="script">

  <!-- Styles -->
  <style>
    /* Loading spinner */
    .loading-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007acc;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* App container */
    #app {
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }

    /* Hide loading container when app is ready */
    body.loaded .loading-container {
      opacity: 0;
      pointer-events: none;
    }

    /* Error styles */
    .error-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      background: #fee;
      color: #c33;
      font-family: monospace;
    }

    .error-message {
      max-width: 600px;
      padding: 20px;
      border: 1px solid #fcc;
      border-radius: 8px;
      background: #fff;
    }
  </style>
</head>
<body>
  <!-- Loading container -->
  <div class="loading-container" id="loading">
    <div class="spinner"></div>
  </div>

  <!-- Main app container -->
  <div id="app"></div>

  <!-- Development error overlay -->
  <div id="error-container" class="error-container" style="display: none;">
    <div class="error-message">
      <h2>üö® Framework Error</h2>
      <pre id="error-message"></pre>
      <button onclick="location.reload()">Reload Page</button>
    </div>
  </div>

  <!-- Main framework script -->
  <script type="module">
    import PydanceClient from '/src/index.js';

    // Global error handler
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      showError(event.error);
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      showError(event.reason);
    });

    function showError(error) {
      const errorContainer = document.getElementById('error-container');
      const errorMessage = document.getElementById('error-message');

      errorMessage.textContent = error.stack || error.message || String(error);
      errorContainer.style.display = 'flex';

      // Hide loading spinner
      const loading = document.getElementById('loading');
      if (loading) {
        loading.style.display = 'none';
      }
    }

    // Initialize framework when DOM is ready
    async function initializeApp() {
      try {
        // Configure framework
        const config = {
          baseURL: import.meta.env.VITE_API_URL || 'http://localhost:8000',
          debug: import.meta.env.DEV,
          enableWebSocket: true,
          enableAuth: true,
          enableNotifications: true,
          enableTheme: true,
          enableCache: true
        };

        // Initialize framework
        const framework = new PydanceClient(config);

        // Mount to DOM
        await framework.mount('#app');

        // Hide loading spinner
        document.body.classList.add('loaded');

        console.log('‚úÖ Pydance Client application started successfully');

      } catch (error) {
        console.error('‚ùå Failed to initialize application:', error);
        showError(error);
      }
    }

    // Start initialization
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>

  <!-- Development helpers (only in development) -->
  <script>
    if (import.meta.env.DEV) {
      // Add development helpers to window
      window.PydanceClient = PydanceClient;

      // Performance monitoring
      if ('performance' in window) {
        window.addEventListener('load', () => {
          setTimeout(() => {
            const perfData = performance.getEntriesByType('navigation')[0];
            console.log('üìä Performance metrics:', {
              'DNS lookup': perfData.domainLookupEnd - perfData.domainLookupStart,
              'TCP connection': perfData.connectEnd - perfData.connectStart,
              'TLS handshake': perfData.secureConnectionStart ? perfData.connectEnd - perfData.secureConnectionStart : 0,
              'Request': perfData.responseStart - perfData.requestStart,
              'Response': perfData.responseEnd - perfData.responseStart,
              'DOM processing': perfData.domContentLoadedEventEnd - perfData.responseEnd,
              'Load complete': perfData.loadEventEnd - perfData.loadEventStart,
              'Total load time': perfData.loadEventEnd - perfData.navigationStart
            });
          }, 0);
        });
      }
    }
  </script>
</body>
</html>
