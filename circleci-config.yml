version: 2.1

orbs:
  python: circleci/python@2.1.1
  node: circleci/node@5.1.0
  docker: circleci/docker@2.2.0

executors:
  python-executor:
    docker:
      - image: cimg/python:3.11
  
  python-with-services:
    docker:
      - image: cimg/python:3.11
      - image: cimg/postgres:15.0
        environment:
          POSTGRES_DB: pydance_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
      - image: cimg/redis:7.0

jobs:
  code-quality:
    executor: python-executor
    steps:
      - checkout
      - python/install-packages:
          pkg-manager: pip
          pip-dependency-file: requirements.txt
      - run:
          name: Install dev dependencies
          command: |
            pip install black isort flake8 mypy bandit safety
      - run:
          name: Code formatting check
          command: |
            black --check src/ tests/
            isort --check-only src/ tests/
      - run:
          name: Linting
          command: |
            flake8 src/ tests/ --output-file=flake8-report.txt
            mypy src/ --junit-xml=mypy-results.xml
      - run:
          name: Security scan
          command: |
            bandit -r src/ -f json -o bandit-report.json
            safety check --json --output safety-report.json
      - store_artifacts:
          path: flake8-report.txt
      - store_artifacts:
          path: bandit-report.json
      - store_artifacts:
          path: safety-report.json
      - store_test_results:
          path: mypy-results.xml

  unit-tests:
    executor: python-executor
    steps:
      - checkout
      - python/install-packages:
          pkg-manager: pip
          pip-dependency-file: requirements.txt
      - run:
          name: Install test dependencies
          command: |
            pip install pytest pytest-cov pytest-asyncio
      - run:
          name: Run unit tests
          command: |
            pytest tests/unit/ --cov=src/pydance --cov-report=xml --cov-report=html --junit-xml=unit-test-results.xml
      - store_test_results:
          path: unit-test-results.xml
      - store_artifacts:
          path: coverage.xml
      - store_artifacts:
          path: htmlcov

  integration-tests:
    executor: python-with-services
    environment:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/pydance_test
      REDIS_URL: redis://localhost:6379/0
    steps:
      - checkout
      - python/install-packages:
          pkg-manager: pip
          pip-dependency-file: requirements.txt
      - run:
          name: Install test dependencies
          command: |
            pip install pytest pytest-asyncio
      - run:
          name: Wait for services
          command: |
            dockerize -wait tcp://localhost:5432 -timeout 1m
            dockerize -wait tcp://localhost:6379 -timeout 1m
      - run:
          name: Run integration tests
          command: |
            pytest tests/integration/ --junit-xml=integration-test-results.xml
      - store_test_results:
          path: integration-test-results.xml

  performance-tests:
    executor: python-executor
    steps:
      - checkout
      - python/install-packages:
          pkg-manager: pip
          pip-dependency-file: requirements.txt
      - run:
          name: Install performance test dependencies
          command: |
            pip install pytest locust
      - run:
          name: Run performance tests
          command: |
            python scripts/test_framework.py
            pytest tests/performance/ --junit-xml=performance-test-results.xml
      - store_test_results:
          path: performance-test-results.xml

  client-tests:
    executor: node/default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: pydance-client
      - run:
          name: Run client tests
          command: |
            cd pydance-client
            npm test
            npm run build
            npm run test:integration
      - store_artifacts:
          path: pydance-client/dist

  build-package:
    executor: python-executor
    steps:
      - checkout
      - python/install-packages:
          pkg-manager: pip
          pip-dependency-file: requirements.txt
      - run:
          name: Install build dependencies
          command: |
            pip install build twine
      - run:
          name: Build package
          command: |
            python -m build
            twine check dist/*
      - store_artifacts:
          path: dist
      - persist_to_workspace:
          root: .
          paths:
            - dist

  build-docker:
    executor: docker/docker
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.14
      - docker/build:
          image: pydance/framework
          tag: << pipeline.git.revision >>
      - when:
          condition:
            or:
              - equal: [ main, << pipeline.git.branch >> ]
              - equal: [ develop, << pipeline.git.branch >> ]
          steps:
            - docker/push:
                image: pydance/framework
                tag: << pipeline.git.revision >>
            - docker/push:
                image: pydance/framework
                tag: latest

  deploy-staging:
    executor: python-executor
    steps:
      - checkout
      - run:
          name: Deploy to staging
          command: |
            echo "Deploying to staging environment"
            # Add staging deployment commands here

  deploy-production:
    executor: python-executor
    steps:
      - checkout
      - run:
          name: Deploy to production
          command: |
            echo "Deploying to production environment"
            # Add production deployment commands here

  publish-pypi:
    executor: python-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install twine
          command: pip install twine
      - run:
          name: Publish to PyPI
          command: |
            twine upload dist/* --username __token__ --password $PYPI_TOKEN

workflows:
  version: 2
  
  test-and-deploy:
    jobs:
      - code-quality
      - unit-tests
      - integration-tests
      - performance-tests
      - client-tests
      
      - build-package:
          requires:
            - code-quality
            - unit-tests
            - integration-tests
      
      - build-docker:
          requires:
            - code-quality
            - unit-tests
            - integration-tests
      
      - deploy-staging:
          requires:
            - build-docker
            - client-tests
          filters:
            branches:
              only: develop
      
      - deploy-production:
          requires:
            - build-docker
            - client-tests
          filters:
            branches:
              only: main
      
      - publish-pypi:
          requires:
            - build-package
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/